<!-- Research Case Study Gallery (paste into page) -->
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* Gallery styles */
  .case-gallery { padding: 40px 0; }
  .case-card { cursor: pointer; border-radius: 12px; overflow: hidden; box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
  .case-card img { width:100%; height:180px; object-fit:cover; display:block;}
  .case-card .case-body { padding:12px; background:#fff; }
  .case-meta { font-size:0.9rem; color:#6b7280; }
  .case-title { font-weight:600; margin-bottom:6px; }
  /* Modal layout */
  .case-modal .modal-dialog { max-width: 1000px; }
  .case-modal .modal-body { display:flex; gap:20px; flex-wrap:wrap; }
  .case-modal .left { flex: 1 1 360px; }
  .case-modal .right { flex: 1 1 520px; }
  .chart-area { background:#fff; border-radius:8px; padding:12px; box-shadow:0 6px 18px rgba(15,23,42,0.04); }
  .chart-controls { display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap;}
  .download-btn { margin-left: auto; }
  @media (max-width:900px){
    .case-modal .modal-body { flex-direction:column; }
  }
</style>

<section id="case-studies" class="case-gallery section">
  <div class="container">
    <div class="section-title text-center mb-4">
      <h2>Research Case Study Gallery</h2>
      <p>Selected case studies with visualized sample data — click a card to explore charts and details.</p>
    </div>

    <div class="row g-3">
      <!-- Case cards: add/remove or change data-id -->
      <div class="col-md-4">
        <div class="case-card" data-case="case1" onclick="openCase('case1')">
          <img src="assets/img/gallery/gallery-1.jpg" alt="Case study 1">
          <div class="case-body">
            <div class="case-title">Case 1 — Rare Variant Investigation</div>
            <div class="case-meta">Chromosome 1 · Candidate gene: OCA2 · Samples: 120</div>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="case-card" data-case="case2" onclick="openCase('case2')">
          <img src="assets/img/gallery/gallery-2.jpg" alt="Case study 2">
          <div class="case-body">
            <div class="case-title">Case 2 — Population Trait Distribution</div>
            <div class="case-meta">Chromosome 7 · Trait: Athletic performance · Samples: 300</div>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="case-card" data-case="case3" onclick="openCase('case3')">
          <img src="assets/img/gallery/gallery-3.jpg" alt="Case study 3">
          <div class="case-body">
            <div class="case-title">Case 3 — Pharmacogenomics</div>
            <div class="case-meta">Chromosome 19 · Gene: CYP2C9 · Samples: 85</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal -->
<div class="modal fade case-modal" id="caseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="caseModalTitle">Case Study</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="left">
          <img id="caseModalImage" src="" alt="" style="width:100%; border-radius:8px; object-fit:cover; max-height:360px;">
          <div style="margin-top:12px;">
            <p id="caseModalSummary" style="color:#374151"></p>
            <div class="case-quick-meta" style="font-size:0.9rem; color:#6b7280;">
              <div><strong>Chromosome:</strong> <span id="caseChromosome"></span></div>
              <div><strong>Genes:</strong> <span id="caseGenes"></span></div>
              <div><strong>Samples:</strong> <span id="caseSamples"></span></div>
            </div>
          </div>
        </div>

        <div class="right">
          <div class="chart-area">
            <div class="d-flex align-items-center chart-controls">
              <div>
                <button class="btn btn-sm btn-outline-primary" onclick="setChartType('bar')">Variant Frequency (bar)</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="setChartType('line')">Trait Trend (line)</button>
                <button class="btn btn-sm btn-outline-success" onclick="setChartType('pie')">Trait Breakdown (pie)</button>
              </div>
              <button class="btn btn-sm btn-outline-dark download-btn" id="downloadCsvBtn" onclick="downloadCaseCSV()">Download CSV</button>
            </div>

            <div style="height:300px;">
              <canvas id="caseChart"></canvas>
            </div>
            <div style="margin-top:12px; color:#6b7280; font-size:0.9rem;">
              <strong>Notes:</strong> <span id="caseNotes">Sample data for demonstration only.</span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <small class="text-muted">This gallery uses mock data and is for educational/demo purposes only.</small>
      </div>
    </div>
  </div>
</div>

<script>
/* ========== Mock case data ========== */
const caseData = {
  case1: {
    title: 'Rare Variant Investigation — OCA2 locus',
    image: 'assets/img/gallery/gallery-1.jpg',
    summary: 'Investigating a rare variant near OCA2 suspected to affect pigmentation. Includes genotyping across 120 samples and allele frequency analysis.',
    chromosome: '1',
    genes: 'OCA2, HERC2',
    samples: 120,
    notes: 'Variant annotation used mock consequence predictions.',
    // datasets for charts:
    variantFrequency: { labels: ['Ref', 'Alt (rs12345)', 'Alt2 (rs6789)'], values: [80, 30, 10] },
    traitTrend: { labels: ['T1','T2','T3','T4','T5'], values: [0.12,0.15,0.13,0.17,0.14] }, // example allele freq over cohorts
    traitBreakdown: { labels: ['Brown/Hazel','Blue','Green'], values: [60,25,15] }
  },
  case2: {
    title: 'Population Trait Distribution — ACTN3 study',
    image: 'assets/img/gallery/gallery-2.jpg',
    summary: 'Population-scale analysis of ACTN3 variants and correlation with endurance performance across 300 samples.',
    chromosome: '7',
    genes: 'ACTN3',
    samples: 300,
    notes: 'Trait score computed from a mock polygenic model.',
    variantFrequency: { labels: ['RR','RX','XX'], values: [160,100,40] },
    traitTrend: { labels: ['2018','2019','2020','2021','2022'], values: [0.32,0.35,0.33,0.36,0.34] },
    traitBreakdown: { labels: ['Low','Moderate','High'], values: [40,140,120] }
  },
  case3: {
    title: 'Pharmacogenomics — CYP2C9 variants',
    image: 'assets/img/gallery/gallery-3.jpg',
    summary: 'Assessment of CYP2C9 variant distribution and predicted metabolizer phenotype in 85 clinical samples.',
    chromosome: '19',
    genes: 'CYP2C9',
    samples: 85,
    notes: 'Phenotype predictions are illustrative.',
    variantFrequency: { labels: ['*1','*2','*3'], values: [55,20,10] },
    traitTrend: { labels: ['Cohort A','Cohort B','Cohort C'], values: [0.65,0.60,0.68] },
    traitBreakdown: { labels: ['Normal','Intermediate','Poor'], values: [50,25,10] }
  }
};

/* ========== Chart handling ========== */
let currentCase = null;
let currentChartType = 'bar';
let chartInstance = null;

function openCase(caseId){
  const c = caseData[caseId];
  if(!c) return;
  currentCase = c;

  // fill modal text and image
  document.getElementById('caseModalTitle').textContent = c.title;
  document.getElementById('caseModalImage').src = c.image;
  document.getElementById('caseModalSummary').textContent = c.summary;
  document.getElementById('caseChromosome').textContent = c.chromosome;
  document.getElementById('caseGenes').textContent = c.genes;
  document.getElementById('caseSamples').textContent = c.samples;
  document.getElementById('caseNotes').textContent = c.notes;

  // default chart type
  setChartType('bar');

  // show Bootstrap modal
  const modal = new bootstrap.Modal(document.getElementById('caseModal'));
  modal.show();
}

function setChartType(type){
  currentChartType = type;
  const ctx = document.getElementById('caseChart').getContext('2d');

  // clear previous chart
  if(chartInstance) { chartInstance.destroy(); chartInstance = null; }

  // choose dataset from currentCase
  let labels = [], values = [], config = {};
  if(type === 'bar'){
    labels = currentCase.variantFrequency.labels;
    values = currentCase.variantFrequency.values;
    config = {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Variant count', data: values, backgroundColor: '#4f46e5' }] },
      options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
    };
  } else if(type === 'line'){
    labels = currentCase.traitTrend.labels;
    values = currentCase.traitTrend.values;
    config = {
      type: 'line',
      data: { labels, datasets: [{ label: 'Trait trend', data: values, fill:false, borderColor:'#059669', tension:0.3 }] },
      options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
    };
  } else if(type === 'pie'){
    labels = currentCase.traitBreakdown.labels;
    values = currentCase.traitBreakdown.values;
    config = {
      type: 'pie',
      data: { labels, datasets: [{ label:'Breakdown', data: values, backgroundColor:['#ef4444','#f59e0b','#3b82f6'] }] },
      options: { responsive:true, plugins:{legend:{position:'bottom'}} }
    };
  }

  chartInstance = new Chart(ctx, config);
}

/* ========== CSV download helper ========== */
function downloadCaseCSV(){
  if(!currentCase) return;
  // build a CSV combining datasets (simple format)
  let csv = 'label,bar_value,line_value,pie_value\n';
  // choose longest labels set to iterate
  const labels = Array.from(new Set([
    ...(currentCase.variantFrequency.labels || []),
    ...(currentCase.traitTrend.labels || []),
    ...(currentCase.traitBreakdown.labels || [])
  ]));
  labels.forEach((label, i) => {
    const barIdx = currentCase.variantFrequency.labels.indexOf(label);
    const lineIdx = currentCase.traitTrend.labels.indexOf(label);
    const pieIdx = currentCase.traitBreakdown.labels.indexOf(label);
    const barVal = barIdx >= 0 ? currentCase.variantFrequency.values[barIdx] : '';
    const lineVal = lineIdx >= 0 ? currentCase.traitTrend.values[lineIdx] : '';
    const pieVal = pieIdx >= 0 ? currentCase.traitBreakdown.values[pieIdx] : '';
    csv += `${label},${barVal},${lineVal},${pieVal}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = (currentCase.title || 'case') .replace(/\s+/g,'_').toLowerCase() + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
</script>
